pipeline {
  agent any
  environment {
    AWS_REGION = "us-east-1"
    CLUSTER_NAME = "my-cluster"
    ECR_REPO = "891377219096.dkr.ecr.us-east-1.amazonaws.com"
  }
  stages {
    stage('Checkout') {
      steps {
        git 'https://github.com/Hibalem/ecommerce.git'
      }
    }
    stage('Build Docker Images') {
      steps {
        script {
          sh 'docker build -t user-service ./services/user-service'
          sh 'docker build -t product-service ./services/product-service'
          sh 'docker build -t order-service ./services/order-service'
        }
      }
    }
    stage('Push to ECR') {
      steps {
        script {
          withAWS(credentials: 'aws-credentials') {
            
            sh "docker tag user-service:latest \${ECR_REPO}/user-service:latest"
            sh "docker tag product-service:latest \${ECR_REPO}/product-service:latest"
             sh "docker tag order-service:latest \${ECR_REPO}/order-service:latest"

            sh "aws ecr get-login-password | docker login --username AWS --password-stdin 891277219096.dkr.ecr.us-east-1.amazonaws.com"

            sh "docker push \${ECR_REPO}/user-service:latest"
            sh "docker push \${ECR_REPO}/product-service:latest"
            sh "docker push \${ECR_REPO}/order-service:latest"
          }
        }
      }
    }
    stage('Deploy to Kubernetes') {
      steps {
        script {
          withAWS(credentials: 'aws-credentials') {
            sh "aws eks update-kubeconfig --region \${AWS_REGION} --name \${CLUSTER_NAME}"
            sh 'kubectl apply -f k8s/app-deployment.yml'
          }
        }
      }
    }
  }
  post {
    failure {
      echo 'Pipeline failed. Check logs for details.'
    }
  }
}